<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSE AI Learner v1.6</title>
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #141414;
            --text-main: #e0e0e0;
            --text-sub: #888;
            --accent: #b388ff; /* Tím AI */
            --match: #00e676; /* Xanh lá khi nhận dạng đúng */
            --font-digital: 'Courier New', Courier, monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-main); padding-bottom: 120px; }

        /* Header */
        header {
            padding: 15px; background: var(--card-bg);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100;
        }
        .app-title { font-weight: bold; font-size: 1.1rem; color: var(--accent); }
        .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; background: #333; }
        .status-active { background: var(--accent); color: #000; font-weight: bold; }

        .dashboard { padding: 10px; display: flex; flex-direction: column; gap: 15px; }

        /* AI Recognition Box */
        .ai-box {
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .ai-result { font-size: 1.8rem; font-weight: bold; color: var(--match); margin: 10px 0; text-shadow: 0 0 10px rgba(0, 230, 118, 0.4); }
        .ai-confidence { font-size: 0.9rem; color: #666; }
        .ai-placeholder { color: #444; font-style: italic; }

        /* Spectrum Canvas */
        .graph-wrapper {
            height: 100px; width: 100%; background: #000;
            border: 1px solid #333; border-radius: 4px; overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Memory List */
        .memory-list { margin-top: 10px; }
        .memory-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #222; padding: 10px; border-radius: 6px; margin-bottom: 5px; border-left: 3px solid #555;
        }
        .memory-name { font-weight: bold; }
        .btn-del { background: transparent; border: 1px solid #ff5252; color: #ff5252; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* Controls */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); padding: 10px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            border-top: 1px solid #333;
        }
        .btn {
            padding: 14px; border: none; border-radius: 8px;
            font-weight: bold; font-size: 1rem; cursor: pointer; text-transform: uppercase;
        }
        .btn-main { background: var(--accent); color: #000; }
        .btn-learn { background: #333; color: var(--accent); border: 1px solid var(--accent); }
        .btn-stop { background: #ff5252; color: #fff; }

    </style>
</head>
<body>

<header>
    <div class="app-title">HSE AI Learner v1.6</div>
    <div id="statusBadge" class="status-badge">READY</div>
</header>

<div class="dashboard">

    <div class="ai-box">
        <div style="font-size: 0.8rem; text-transform: uppercase; color: #666;">AI Đang nghe:</div>
        <div id="ai-output" class="ai-result ai-placeholder">...</div>
        <div id="ai-conf" class="ai-confidence">Độ khớp: --%</div>
    </div>

    <div class="graph-wrapper">
        <canvas id="canvas-spectrum"></canvas>
    </div>

    <div style="padding: 5px;">
        <h3 style="font-size: 0.9rem; color: #888; text-transform: uppercase;">Bộ nhớ đã học (<span id="mem-count">0</span>)</h3>
        <div id="memory-container" class="memory-list">
            </div>
        <div style="font-size: 0.7rem; color: #555; margin-top:5px; font-style: italic;">
            *Dữ liệu được lưu trong trình duyệt của bạn.
        </div>
    </div>

</div>

<div class="action-bar">
    <button id="btnToggle" class="btn btn-main" onclick="toggleApp()">Bắt đầu</button>
    <button id="btnLearn" class="btn btn-learn" onclick="learnCurrentSound()" disabled>+ Học mẫu này</button>
</div>

<script>
    // --- CONFIGURATION ---
    const FFT_SIZE = 512; // 256 frequency bins
    const FEATURE_SIZE = 32; // Downsample to 32 bands for fingerprint
    const MATCH_THRESHOLD = 30; // Lower is stricter (Euclidean distance)
    
    // --- STATE ---
    let isRunning = false;
    let audioCtx, analyser, dataArray;
    let learnedSounds = []; // { name: "Motor", features: [...] }

    // --- INITIALIZATION ---
    window.onload = function() {
        loadMemories();
    };

    function loadMemories() {
        const saved = localStorage.getItem('hse_ai_memories');
        if (saved) {
            learnedSounds = JSON.parse(saved);
            renderMemoryList();
        }
    }

    function saveMemories() {
        localStorage.setItem('hse_ai_memories', JSON.stringify(learnedSounds));
        renderMemoryList();
    }

    // --- AUDIO ENGINE ---
    async function toggleApp() {
        const btn = document.getElementById('btnToggle');
        const btnLearn = document.getElementById('btnLearn');
        const badge = document.getElementById('statusBadge');

        if (!isRunning) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                
                // Quan trọng: Smoothing cao (0.9) để đặc trưng ổn định, dễ học
                analyser.smoothingTimeConstant = 0.9; 
                analyser.fftSize = FFT_SIZE;
                
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                isRunning = true;
                btn.textContent = "Dừng lại";
                btn.className = "btn btn-stop";
                btnLearn.disabled = false;
                badge.textContent = "LISTENING";
                badge.className = "status-badge status-active";
                
                loop();
            } catch (e) { alert("Lỗi Mic: " + e.message); }
        } else {
            if(audioCtx) audioCtx.close();
            isRunning = false;
            btn.textContent = "Bắt đầu";
            btn.className = "btn btn-main";
            btnLearn.disabled = true;
            badge.textContent = "STOPPED";
            badge.className = "status-badge";
        }
    }

    // --- FEATURE EXTRACTION (The "Brain") ---
    function extractFeatures(rawFeatures) {
        // Nén 256 bin FFT xuống thành 32 bin (Fingerprint)
        // Bằng cách lấy trung bình cộng các nhóm tần số
        let features = new Array(FEATURE_SIZE).fill(0);
        const blockSize = Math.floor(rawFeatures.length / FEATURE_SIZE);
        
        for (let i = 0; i < FEATURE_SIZE; i++) {
            let sum = 0;
            for (let j = 0; j < blockSize; j++) {
                sum += rawFeatures[i * blockSize + j];
            }
            features[i] = sum / blockSize; // Average magnitude
        }
        return features;
    }

    // --- LEARNING FUNCTION ---
    function learnCurrentSound() {
        if (!isRunning) return;
        
        // 1. Capture current features
        const currentFingerprint = extractFeatures(dataArray);
        
        // 2. Check if valid (not silence)
        const energy = currentFingerprint.reduce((a, b) => a + b, 0) / FEATURE_SIZE;
        if (energy < 10) {
            alert("Âm thanh quá nhỏ để học!");
            return;
        }

        // 3. Prompt user for name
        const name = prompt("Đặt tên cho âm thanh này (VD: Máy bơm, Tiếng còi...):");
        if (name) {
            learnedSounds.push({
                id: Date.now(),
                name: name,
                features: currentFingerprint
            });
            saveMemories();
            alert(`Đã học: "${name}"`);
        }
    }

    // --- CLASSIFICATION FUNCTION ---
    function classify(currentFeatures) {
        if (learnedSounds.length === 0) return null;

        let bestMatch = null;
        let minDistance = Infinity;

        // So khớp Features hiện tại với từng mẫu trong Memory
        for (let sound of learnedSounds) {
            let distance = 0;
            // Euclidean Distance (Khoảng cách Euclide)
            for (let i = 0; i < FEATURE_SIZE; i++) {
                let diff = currentFeatures[i] - sound.features[i];
                distance += diff * diff;
            }
            distance = Math.sqrt(distance);

            if (distance < minDistance) {
                minDistance = distance;
                bestMatch = sound;
            }
        }

        // Normalization score for UI (0-100%)
        // Giả sử distance > 100 là không khớp
        let confidence = Math.max(0, 100 - minDistance); 
        
        return { 
            match: bestMatch, 
            distance: minDistance,
            confidence: confidence
        };
    }

    // --- MAIN LOOP ---
    function loop() {
        if (!isRunning) return;
        requestAnimationFrame(loop);

        analyser.getByteFrequencyData(dataArray);

        // 1. Draw Spectrum
        drawSpectrum(dataArray);

        // 2. AI Process
        const features = extractFeatures(dataArray);
        const result = classify(features);
        
        const uiOut = document.getElementById('ai-output');
        const uiConf = document.getElementById('ai-conf');
        const uiBox = document.querySelector('.ai-box');

        if (result && result.distance < MATCH_THRESHOLD) {
            // MATCH FOUND
            uiOut.innerText = result.match.name;
            uiOut.classList.remove('ai-placeholder');
            uiConf.innerText = `Độ tin cậy: ${Math.round(result.confidence)}%`;
            uiBox.style.borderColor = "#00e676"; // Green border
        } else {
            // NO MATCH / UNKNOWN
            uiOut.innerText = "Chưa biết / Tạp âm";
            uiOut.classList.add('ai-placeholder');
            uiConf.innerText = "Đang quét...";
            uiBox.style.borderColor = "#333"; // Default border
        }
    }

    // --- UI HELPERS ---
    function drawSpectrum(data) {
        const canvas = document.getElementById('canvas-spectrum');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;
        
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, w, h);
        
        const barWidth = (w / data.length) * 2.5;
        let x = 0;

        for(let i = 0; i < data.length; i++) {
            const barHeight = data[i] / 2;
            ctx.fillStyle = `rgb(${data[i] + 100}, 50, 200)`;
            ctx.fillRect(x, h - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }

    function renderMemoryList() {
        const container = document.getElementById('memory-container');
        const count = document.getElementById('mem-count');
        container.innerHTML = '';
        count.innerText = learnedSounds.length;

        learnedSounds.forEach((sound, index) => {
            const div = document.createElement('div');
            div.className = 'memory-item';
            div.innerHTML = `
                <span class="memory-name">${sound.name}</span>
                <button class="btn-del" onclick="deleteMemory(${index})">Xóa</button>
            `;
            container.appendChild(div);
        });
    }

    window.deleteMemory = function(index) {
        if(confirm("Xóa mẫu âm thanh này?")) {
            learnedSounds.splice(index, 1);
            saveMemories();
        }
    }
</script>

</body>
</html>
