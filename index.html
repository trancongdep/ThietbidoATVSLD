
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Altimeter & Camera</title>
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBXQSBBbHRpbWV0ZXIiLAogICJzaG9ydF9uYW1lIjogIkFsdGltZXRlciIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzIxOTZGMyIsCiAgImljb25zIjogW3sgInNyYyI6ICJodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vMTkyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIiwgInNpemVzIjogIjE5MngxOTIifSBdfQp9">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #121212; color: white; display: flex; flex-direction: column; height: 100vh; }
        #camera-container { position: relative; flex: 1; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        #overlay { position: absolute; bottom: 15px; left: 15px; font-size: 13px; background: rgba(0,0,0,0.6); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); }
        .altimeter-display { position: absolute; top: 20px; right: 20px; background: rgba(33, 150, 243, 0.8); padding: 10px 20px; border-radius: 10px; text-align: center; }
        .altimeter-display span { font-size: 24px; font-weight: bold; display: block; }

        .controls { padding: 20px; background: #1e1e1e; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 2px solid #333; }
        .input-full { grid-column: span 2; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        
        button { padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-reset { background: #f44336; color: white; }
        .btn-capture { background: #fff; color: #000; font-size: 18px; }
        
        #preview-canvas { display: none; }
        .no-sensor { font-size: 10px; color: #ffeb3b; margin-top: 5px; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="video" autoplay playsinline></video>
    
    <div class="altimeter-display">
        <small>ĐỘ CAO (M)</small>
        <span id="display-height">0.00</span>
    </div>

    <div id="overlay">
        <div id="meta-user">Người chụp: --</div>
        <div id="meta-gps">GPS: Đang lấy...</div>
        <div id="meta-height">Cao độ: 0.00 m</div>
        <div id="meta-heading">Hướng: --°</div>
    </div>
</div>

<div class="controls">
    <div class="input-full">
        <input type="text" id="username" placeholder="Tên người chụp">
        <input type="text" id="note" placeholder="Ghi chú">
    </div>
    <button class="btn-reset" onclick="resetAltitude()">BẮT ĐẦU TẠI ĐẤT</button>
    <button class="btn-capture" onclick="takePhoto()">CHỤP ẢNH</button>
</div>

<canvas id="preview-canvas"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('preview-canvas');
    const heightDisplay = document.getElementById('display-height');
    
    let basePressure = null;
    let currentPressure = null;
    let currentHeight = 0;
    let currentHeading = 0;
    let currentCoords = "N/A";

    // 1. Khởi tạo Camera
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) { alert("Lỗi camera: " + err); }
    }

    // 2. Cảm biến Áp suất (Barometer)
    function initBarometer() {
        if ('Sensor' in window && 'PressureSensor' in window) {
            try {
                const sensor = new PressureSensor({ frequency: 10 });
                sensor.addEventListener('reading', () => {
                    currentPressure = sensor.pressure; // Đơn vị: hPa
                    calculateHeight();
                });
                sensor.start();
            } catch (err) {
                console.error("Cảm biến áp suất không hỗ trợ.");
            }
        } else {
            heightDisplay.innerHTML = "N/A <div class='no-sensor'>Thiết bị không có cảm biến áp suất</div>";
        }
    }

    // 3. Reset độ cao (Đặt Android xuống mặt đất rồi bấm)
    function resetAltitude() {
        if (currentPressure) {
            basePressure = currentPressure;
            alert("Đã xác định mặt đất! Hãy đưa thiết bị lên cao.");
        } else {
            alert("Đang đợi dữ liệu cảm biến...");
        }
    }

    // 4. Tính toán độ cao dựa trên chênh lệch áp suất
    // Công thức đơn giản: 1 hPa ≈ 8.43 mét ở mực nước biển
    function calculateHeight() {
        if (basePressure && currentPressure) {
            // Công thức Hypsometric đơn giản hóa
            currentHeight = (basePressure - currentPressure) * 8.43;
            if (currentHeight < 0) currentHeight = 0; // Tránh nhiễu âm
            heightDisplay.innerText = currentHeight.toFixed(2);
            document.getElementById('meta-height').innerText = `Cao độ: ${currentHeight.toFixed(2)} m`;
        }
    }

    // 5. GPS & Hướng
    function watchData() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                currentCoords = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                document.getElementById('meta-gps').innerText = `GPS: ${currentCoords}`;
            }, null, { enableHighAccuracy: true });
        }
        window.addEventListener('deviceorientationabsolute', (e) => {
            if (e.alpha !== null) {
                currentHeading = Math.round(e.alpha);
                document.getElementById('meta-heading').innerText = `Hướng: ${currentHeading}°`;
            }
        });
    }

    function takePhoto() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const fontSize = Math.floor(canvas.height / 25);
        context.font = `bold ${fontSize}px Arial`;
        context.fillStyle = "yellow";
        context.shadowColor = "black";
        context.shadowBlur = 7;

        const info = [
            `Người chụp: ${document.getElementById('username').value || 'N/A'}`,
            `Ghi chú: ${document.getElementById('note').value || 'Không'}`,
            `Cao độ: ${currentHeight.toFixed(2)} m (Relative)`,
            `GPS: ${currentCoords}`,
            `Hướng: ${currentHeading}°`,
            `Thời gian: ${new Date().toLocaleString()}`
        ];

        info.reverse().forEach((text, i) => {
            context.fillText(text, 30, canvas.height - 40 - (i * fontSize * 1.3));
        });

        const link = document.createElement('a');
        link.download = `Survey_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    window.onload = () => {
        initCamera();
        initBarometer();
        watchData();
        setInterval(() => {
            const user = document.getElementById('username').value || "--";
            document.getElementById('meta-user').innerText = `Người chụp: ${user}`;
        }, 1000);
    };
</script>
</body>
</html>
