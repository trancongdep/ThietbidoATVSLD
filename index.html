
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Smart Camera v2.1</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #121212; color: white; display: flex; flex-direction: column; height: 100vh; }
        #camera-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #overlay { position: absolute; bottom: 10px; left: 10px; font-size: 11px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 5px; line-height: 1.4; }
        .altimeter-display { position: absolute; top: 15px; right: 15px; background: #2196F3; padding: 8px 15px; border-radius: 8px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .altimeter-display span { font-size: 22px; font-weight: bold; display: block; }
        .method-tag { font-size: 9px; background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px; }
        .controls { padding: 15px; background: #1e1e1e; display: flex; flex-direction: column; gap: 10px; }
        .btn-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-reset { background: #f44336; color: white; }
        .btn-capture { background: #fff; color: #000; }
        #preview-canvas { display: none; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <div class="altimeter-display">
        <small>ĐỘ CAO CHÊNH LỆCH</small>
        <span id="display-height">0.00 m</span>
        <div id="method-text" class="method-tag">Đang kiểm tra cảm biến...</div>
    </div>
    <div id="overlay">
        <div id="meta-user">Người chụp: --</div>
        <div id="meta-gps">GPS: Đang lấy...</div>
        <div id="meta-alt">Cao độ (m): 0.00</div>
        <div id="meta-heading">Hướng: --°</div>
    </div>
</div>

<div class="controls">
    <input type="text" id="username" placeholder="Tên người chụp" oninput="updateUI()">
    <div class="btn-group">
        <button class="btn-reset" onclick="setBaseline()">ĐẶT MỐC 0 (MẶT ĐẤT)</button>
        <button class="btn-capture" onclick="takePhoto()">CHỤP ẢNH</button>
    </div>
</div>

<canvas id="preview-canvas"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('preview-canvas');
    let baselineAltitude = null;
    let currentAltitude = 0;
    let relativeHeight = 0;
    let currentHeading = 0;
    let coordsText = "N/A";
    let measurementMethod = "GPS";

    // 1. Khởi tạo Camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => video.srcObject = stream);

    // 2. Cảm biến áp suất (Ưu tiên số 1)
    if ('PressureSensor' in window) {
        try {
            const sensor = new PressureSensor({ frequency: 5 });
            sensor.addEventHandler('reading', () => {
                measurementMethod = "BAROMETER";
                document.getElementById('method-text').innerText = "Cảm biến: Áp suất (Chính xác cao)";
                // Chuyển đổi áp suất sang độ cao tương đối (1hPa ~ 8.43m)
                currentAltitude = (1013.25 - sensor.pressure) * 8.43; 
                updateHeightCalculation();
            });
            sensor.start();
        } catch(e) { console.log("Lỗi khởi động Barometer"); }
    }

    // 3. GPS (Dự phòng cho S21 nếu Barometer bị chặn)
    navigator.geolocation.watchPosition(pos => {
        coordsText = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        document.getElementById('meta-gps').innerText = `GPS: ${coordsText}`;
        
        if (measurementMethod !== "BAROMETER") {
            measurementMethod = "GPS";
            document.getElementById('method-text').innerText = "Cảm biến: GPS (Sai số ~3-5m)";
            currentAltitude = pos.coords.altitude || 0;
            updateHeightCalculation();
        }
    }, err => console.log(err), { enableHighAccuracy: true });

    // 4. Tính toán độ cao chênh lệch
    function setBaseline() {
        baselineAltitude = currentAltitude;
        alert("Đã đặt mốc 0 tại vị trí này!");
    }

    function updateHeightCalculation() {
        if (baselineAltitude !== null) {
            relativeHeight = currentAltitude - baselineAltitude;
        } else {
            relativeHeight = 0;
        }
        document.getElementById('display-height').innerText = relativeHeight.toFixed(2) + " m";
        document.getElementById('meta-alt').innerText = `Cao độ chênh lệch: ${relativeHeight.toFixed(2)} m`;
    }

    // 5. Hướng và UI
    window.addEventListener('deviceorientationabsolute', e => {
        if (e.alpha !== null) {
            currentHeading = Math.round(e.alpha);
            document.getElementById('meta-heading').innerText = `Hướng: ${currentHeading}°`;
        }
    });

    function updateUI() {
        document.getElementById('meta-user').innerText = `Người chụp: ${document.getElementById('username').value || '--'}`;
    }

    function takePhoto() {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        ctx.font = "bold 30px Arial";
        ctx.fillStyle = "yellow";
        ctx.shadowColor = "black";
        ctx.shadowBlur = 5;

        const data = [
            `Người chụp: ${document.getElementById('username').value || 'N/A'}`,
            `Cao độ: ${relativeHeight.toFixed(2)} m (Mốc 0 mặt đất)`,
            `GPS: ${coordsText}`,
            `Hướng: ${currentHeading}°`,
            `Phương pháp: ${measurementMethod}`,
            `Thời gian: ${new Date().toLocaleString()}`
        ];

        data.reverse().forEach((text, i) => {
            ctx.fillText(text, 20, canvas.height - 30 - (i * 40));
        });

        const link = document.createElement('a');
        link.download = `S21_Survey_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
